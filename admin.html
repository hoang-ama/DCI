<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DCI Admin Dashboard</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <!-- Babel -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background-color: #f3f4f6; }
        .markdown-editor { min-height: 200px; font-family: monospace; }
        .loader { border: 4px solid #f3f3f3; border-top: 4px solid #3498db; border-radius: 50%; width: 30px; height: 30px; animation: spin 2s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        // ==========================================
        // 1. FIREBASE CONFIGURATION 
        // ==========================================
        const firebaseConfig = {
            apiKey: "AIzaSyAeaWwx00U2fLJDCneUWB6OnIe-IotGX8Q",
            authDomain: "dci-website-181225.firebaseapp.com",
            projectId: "dci-website-181225",
            storageBucket: "dci-website-181225.firebasestorage.app",
            messagingSenderId: "925113398750",
            appId: "1:925113398750:web:c6ab114f37db529a0ed94f",
            measurementId: "G-6EXZF52E4T"
        };


        // Initialize Firebase
        if (!firebase.apps.length) {
            firebase.initializeApp(firebaseConfig);
        }
        const db = firebase.firestore();
        const auth = firebase.auth();

        const { useState, useEffect } = React;

        // ==========================================
        // 2. UI COMPONENTS
        // ==========================================

        // --- Login Screen ---
        const LoginScreen = ({ onLogin }) => {
            const [email, setEmail] = useState('');
            const [password, setPassword] = useState('');
            const [error, setError] = useState('');
            const [loading, setLoading] = useState(false);

            const handleLogin = async (e) => {
                e.preventDefault();
                setLoading(true);
                setError('');
                try {
                    await auth.signInWithEmailAndPassword(email, password);
                } catch (err) {
                    setError('Login failed: ' + err.message);
                    setLoading(false);
                }
            };

            return (
                <div className="min-h-screen flex items-center justify-center bg-gray-100">
                    <div className="bg-white p-8 rounded-lg shadow-lg w-96">
                        <div className="text-center mb-6">
                            <h1 className="text-2xl font-bold text-green-800">DCI Admin</h1>
                            <p className="text-gray-500 text-sm">Website Content Management</p>
                        </div>
                        <form onSubmit={handleLogin}>
                            <div className="mb-4">
                                <label className="block text-gray-700 text-sm font-bold mb-2">Email</label>
                                <input type="email" value={email} onChange={(e) => setEmail(e.target.value)} 
                                    className="w-full px-3 py-2 border rounded focus:outline-none focus:ring-2 focus:ring-green-500" required />
                            </div>
                            <div className="mb-6">
                                <label className="block text-gray-700 text-sm font-bold mb-2">Password</label>
                                <input type="password" value={password} onChange={(e) => setPassword(e.target.value)} 
                                    className="w-full px-3 py-2 border rounded focus:outline-none focus:ring-2 focus:ring-green-500" required />
                            </div>
                            {error && <p className="text-red-500 text-xs italic mb-4">{error}</p>}
                            <button type="submit" disabled={loading}
                                className="w-full bg-green-700 text-white font-bold py-2 px-4 rounded hover:bg-green-800 focus:outline-none focus:shadow-outline">
                                {loading ? 'Processing...' : 'Login'}
                            </button>
                        </form>
                    </div>
                </div>
            );
        };

        // --- Image Selector Component ---
        const ImageSelector = ({ value, onChange }) => {
            const [imageMode, setImageMode] = useState(value && value.startsWith('./image/') ? 'folder' : 'url');
            const [availableImages, setAvailableImages] = useState([]);
            const [loading, setLoading] = useState(false);

            useEffect(() => {
                // List of available images from the /image folder
                // In a real app, you'd fetch this from the server
                const images = [
                    'aNam.jpg', 'aNam1.jpg', 'CarX_logo.png', 'Chungxe_logo-rec.png',
                    'Chungxe_squa_logo.svg', 'Chungxe_square_logo.png', 'Chungxe_square_logo.svg',
                    'CX_square_logo.png', 'DC Logo_white.png', 'DCExpress_logo.png',
                    'DCI_logo_color.svg', 'DCI_white.svg', 'DCI-Slider.png',
                    'Dichoichung_logo.png', 'Dichung_logo-removebg.png', 'Dichung_logo.png',
                    'Dichung_logo.svg', 'Dichung.jpg', 'DichungMart_logo.png',
                    'DichungTransport_logo.png', 'DichungTravel_Logo.png', 'favicon.png',
                    'FoundingTeam.jpg', 'homepage-bg.png', 'Logo_Chungxe.png',
                    'onCar_logo.png', 'Parkchung_logo.svg', 'Parkchung_present.jpg',
                    'Team.HEIC', 'TotMart_logo.png', 'Vshare_logo.png', 'Youthplus_logo.png'
                ];
                setAvailableImages(images);
            }, []);

            const handleUrlChange = (e) => {
                onChange(e.target.value);
            };

            const handleImageSelect = (imageName) => {
                onChange(`./image/${imageName}`);
            };

            return (
                <div className="border rounded p-4 bg-gray-50">
                    <div className="mb-4">
                        <div className="flex gap-4 mb-4">
                            <label className="flex items-center">
                                <input 
                                    type="radio" 
                                    value="url" 
                                    checked={imageMode === 'url'} 
                                    onChange={(e) => setImageMode(e.target.value)}
                                    className="mr-2"
                                />
                                <span>URL Link</span>
                            </label>
                            <label className="flex items-center">
                                <input 
                                    type="radio" 
                                    value="folder" 
                                    checked={imageMode === 'folder'} 
                                    onChange={(e) => setImageMode(e.target.value)}
                                    className="mr-2"
                                />
                                <span>Select from Folder</span>
                            </label>
                        </div>
                    </div>

                    {imageMode === 'url' ? (
                        <div>
                            <input 
                                type="text" 
                                placeholder="Enter image URL (http://... or https://...)"
                                value={value || ''}
                                onChange={handleUrlChange}
                                className="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline"
                            />
                            {value && value.startsWith('http') && (
                                <div className="mt-3">
                                    <img src={value} alt="Preview" className="max-w-xs max-h-32 rounded border" />
                                </div>
                            )}
                        </div>
                    ) : (
                        <div>
                            <p className="text-sm text-gray-600 mb-3">Select an image from the /image folder:</p>
                            <div className="grid grid-cols-3 gap-3 max-h-64 overflow-y-auto">
                                {availableImages.map(img => (
                                    <div key={img} className="cursor-pointer">
                                        <button
                                            type="button"
                                            onClick={() => handleImageSelect(img)}
                                            className={`w-full p-2 rounded text-sm border text-center truncate transition ${
                                                value === `./image/${img}` 
                                                    ? 'border-green-600 bg-green-100 font-bold' 
                                                    : 'border-gray-300 hover:bg-gray-100'
                                            }`}
                                            title={img}
                                        >
                                            {img}
                                        </button>
                                    </div>
                                ))}
                            </div>
                            {value && value.startsWith('./image/') && (
                                <div className="mt-3">
                                    <img src={value} alt="Preview" className="max-w-xs max-h-32 rounded border" />
                                </div>
                            )}
                        </div>
                    )}
                </div>
            );
        };

        // --- Generic Item Editor (Dynamic Form) ---
        const ItemEditor = ({ collectionName, item, onSave, onCancel }) => {
            const [formData, setFormData] = useState(item || {});
            const [saving, setSaving] = useState(false);

            // Data schema configuration for each type
            const schema = {
                'posts': [
                    { key: 'title', label: 'Post Title', type: 'text' },
                    { key: 'date', label: 'Date (YYYY-MM-DD)', type: 'date' },
                    { key: 'author', label: 'Author', type: 'text' },
                    { key: 'category', label: 'Category', type: 'select', options: ['Studio', 'Investor', 'Founder', 'Startup'] },
                    { key: 'tags', label: 'Tags (comma separated)', type: 'text' },
                    { key: 'featured', label: 'Featured on Homepage', type: 'checkbox' },
                    { key: 'image', label: 'Cover Image URL', type: 'image' },
                    { key: 'summary', label: 'Short Summary', type: 'textarea' },
                    { key: 'content', label: 'Content (Markdown)', type: 'markdown' }
                ],
                'jobs': [
                    { key: 'title', label: 'Job Title', type: 'text' },
                    { key: 'location', label: 'Location', type: 'text' },
                    { key: 'type', label: 'Type (Full-time/Part-time)', type: 'text' },
                    { key: 'salary', label: 'Salary', type: 'text' },
                    { key: 'content', label: 'Job Description (Markdown)', type: 'markdown' }
                ],
                'companies': [
                    { key: 'name', label: 'Startup/Company Name', type: 'text' },
                    { key: 'vertical', label: 'Vertical', type: 'text' },
                    { key: 'logo', label: 'Logo URL', type: 'text' },
                    { key: 'website', label: 'Website URL', type: 'text' },
                    { key: 'stage', label: 'Stage', type: 'text' },
                    { key: 'description', label: 'Short Description', type: 'textarea' },
                    { key: 'content', label: 'Details (Markdown)', type: 'markdown' }
                ]
            };

            const fields = schema[collectionName] || [];

            const handleChange = (key, value) => {
                setFormData(prev => ({ ...prev, [key]: value }));
            };

            const handleSubmit = async (e) => {
                e.preventDefault();
                setSaving(true);
                try {
                    if (item && item.id) {
                        // Update
                        await db.collection(collectionName).doc(item.id).update(formData);
                    } else {
                        // Create
                        await db.collection(collectionName).add({
                            ...formData,
                            createdAt: new Date()
                        });
                    }
                    onSave();
                } catch (error) {
                    alert("Error saving: " + error.message);
                    setSaving(false);
                }
            };

            return (
                <div className="bg-white p-6 rounded shadow">
                    <h2 className="text-xl font-bold mb-4 border-b pb-2">
                        {item ? 'Edit' : 'Add New'} - {collectionName === 'posts' ? 'Post' : collectionName === 'jobs' ? 'Job' : 'Portfolio'}
                    </h2>
                    <form onSubmit={handleSubmit}>
                        {fields.map(field => (
                            <div key={field.key} className="mb-4">
                                {field.type === 'checkbox' ? (
                                    <label className="flex items-center">
                                        <input 
                                            type="checkbox" 
                                            className="mr-2 w-4 h-4"
                                            checked={formData[field.key] || false}
                                            onChange={(e) => handleChange(field.key, e.target.checked)}
                                        />
                                        <span className="text-gray-700 text-sm font-bold">{field.label}</span>
                                    </label>
                                ) : (
                                    <>
                                        <label className="block text-gray-700 text-sm font-bold mb-2">{field.label}</label>
                                        {field.type === 'text' || field.type === 'date' ? (
                                            <input 
                                                type={field.type} 
                                                className="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline"
                                                value={formData[field.key] || ''}
                                                onChange={(e) => handleChange(field.key, e.target.value)}
                                                required={field.key === 'title' || field.key === 'name'}
                                            />
                                        ) : field.type === 'select' ? (
                                            <select 
                                                className="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline"
                                                value={formData[field.key] || ''}
                                                onChange={(e) => handleChange(field.key, e.target.value)}
                                            >
                                                <option value="">-- Select {field.label} --</option>
                                                {field.options && field.options.map(opt => (
                                                    <option key={opt} value={opt}>{opt}</option>
                                                ))}
                                            </select>
                                        ) : field.type === 'textarea' ? (
                                            <textarea 
                                                className="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline"
                                                rows="3"
                                                value={formData[field.key] || ''}
                                                onChange={(e) => handleChange(field.key, e.target.value)}
                                            />
                                        ) : field.type === 'markdown' ? (
                                            <textarea 
                                                className="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline markdown-editor bg-gray-50"
                                                rows="10"
                                                value={formData[field.key] || ''}
                                                onChange={(e) => handleChange(field.key, e.target.value)}
                                                placeholder="# Write Markdown content here..."
                                            />
                                        ) : field.type === 'image' ? (
                                            <ImageSelector 
                                                value={formData[field.key] || ''}
                                                onChange={(value) => handleChange(field.key, value)}
                                            />
                                        ) : null}
                                    </>
                                )}
                            </div>
                        ))}
                        <div className="flex justify-end gap-3 mt-6">
                            <button type="button" onClick={onCancel} className="bg-gray-500 text-white font-bold py-2 px-4 rounded hover:bg-gray-700">
                                Cancel
                            </button>
                            <button type="submit" disabled={saving} className="bg-green-600 text-white font-bold py-2 px-4 rounded hover:bg-green-700">
                                {saving ? 'Saving...' : 'Save Data'}
                            </button>
                        </div>
                    </form>
                </div>
            );
        };

        // --- Data List Component ---
        const DataList = ({ collectionName, onEdit }) => {
            const [items, setItems] = useState([]);
            const [loading, setLoading] = useState(true);

            useEffect(() => {
                setLoading(true);
                const unsubscribe = db.collection(collectionName).orderBy('createdAt', 'desc').onSnapshot(snapshot => {
                    const data = snapshot.docs.map(doc => ({
                        id: doc.id,
                        ...doc.data()
                    }));
                    setItems(data);
                    setLoading(false);
                }, (error) => {
                    console.error("Error fetching data: ", error);
                    setLoading(false);
                });
                return () => unsubscribe();
            }, [collectionName]);

            const handleDelete = async (id) => {
                if (confirm('Are you sure you want to delete this item? This action cannot be undone.')) {
                    try {
                        await db.collection(collectionName).doc(id).delete();
                    } catch (err) {
                        alert('Delete failed: ' + err.message);
                    }
                }
            };

            if (loading) return <div className="flex justify-center p-10"><div className="loader"></div></div>;

            return (
                <div>
                    <div className="flex justify-between items-center mb-6">
                        <h2 className="text-2xl font-bold text-gray-800 capitalize">
                            List of {collectionName === 'posts' ? 'Posts' : collectionName === 'jobs' ? 'Jobs' : 'Portfolio'}
                        </h2>
                        <button onClick={() => onEdit(null)} className="bg-blue-600 text-white font-bold py-2 px-4 rounded hover:bg-blue-700">
                            <i className="fas fa-plus mr-2"></i> Add New
                        </button>
                    </div>

                    <div className="bg-white shadow-md rounded my-6 overflow-x-auto">
                        <table className="min-w-full table-auto">
                            <thead>
                                <tr className="bg-gray-200 text-gray-600 uppercase text-sm leading-normal">
                                    <th className="py-3 px-6 text-left">Title / Name</th>
                                    <th className="py-3 px-6 text-left">Additional Info</th>
                                    <th className="py-3 px-6 text-center">Actions</th>
                                </tr>
                            </thead>
                            <tbody className="text-gray-600 text-sm font-light">
                                {items.length === 0 ? (
                                    <tr><td colSpan="3" className="text-center py-6">No data available.</td></tr>
                                ) : items.map(item => (
                                    <tr key={item.id} className="border-b border-gray-200 hover:bg-gray-100">
                                        <td className="py-3 px-6 text-left whitespace-nowrap">
                                            <span className="font-medium">{item.title || item.name}</span>
                                        </td>
                                        <td className="py-3 px-6 text-left">
                                            {collectionName === 'posts' && <span>{item.date}</span>}
                                            {collectionName === 'jobs' && <span>{item.location} - {item.type}</span>}
                                            {collectionName === 'companies' && <span>{item.vertical}</span>}
                                        </td>
                                        <td className="py-3 px-6 text-center">
                                            <div className="flex item-center justify-center">
                                                <button onClick={() => onEdit(item)} className="w-4 mr-2 transform hover:text-purple-500 hover:scale-110">
                                                    <i className="fas fa-edit"></i>
                                                </button>
                                                <button onClick={() => handleDelete(item.id)} className="w-4 mr-2 transform hover:text-red-500 hover:scale-110">
                                                    <i className="fas fa-trash-alt"></i>
                                                </button>
                                            </div>
                                        </td>
                                    </tr>
                                ))}
                            </tbody>
                        </table>
                    </div>
                </div>
            );
        };

        // --- Main Application ---
        const App = () => {
            const [user, setUser] = useState(null);
            const [activeTab, setActiveTab] = useState('posts'); // posts, jobs, companies
            const [viewMode, setViewMode] = useState('list'); // list, edit
            const [currentItem, setCurrentItem] = useState(null);
            const [initializing, setInitializing] = useState(true);

            useEffect(() => {
                const unsubscribe = auth.onAuthStateChanged((u) => {
                    setUser(u);
                    setInitializing(false);
                });
                return unsubscribe;
            }, []);

            if (initializing) return <div className="min-h-screen flex items-center justify-center">Loading...</div>;

            if (!user) {
                return <LoginScreen />;
            }

            const handleLogout = () => auth.signOut();

            const handleEdit = (item) => {
                setCurrentItem(item);
                setViewMode('edit');
            };

            const handleSaveSuccess = () => {
                setViewMode('list');
                setCurrentItem(null);
            };

            const renderContent = () => {
                if (viewMode === 'edit') {
                    return (
                        <ItemEditor 
                            collectionName={activeTab} 
                            item={currentItem} 
                            onSave={handleSaveSuccess} 
                            onCancel={() => setViewMode('list')}
                        />
                    );
                }
                return <DataList collectionName={activeTab} onEdit={handleEdit} />;
            };

            return (
                <div className="flex min-h-screen">
                    {/* Sidebar */}
                    <aside className="w-64 bg-green-900 text-white flex flex-col shadow-lg">
                        <div className="p-6 text-center border-b border-green-800">
                            <h1 className="text-2xl font-bold">DCI Admin</h1>
                        </div>
                        <nav className="flex-1 py-6">
                            <button 
                                onClick={() => { setActiveTab('posts'); setViewMode('list'); }}
                                className={`w-full text-left py-3 px-6 hover:bg-green-800 transition ${activeTab === 'posts' ? 'bg-green-800 border-l-4 border-yellow-400' : ''}`}
                            >
                                <i className="fas fa-blog w-6"></i> Blog / News
                            </button>
                            <button 
                                onClick={() => { setActiveTab('jobs'); setViewMode('list'); }}
                                className={`w-full text-left py-3 px-6 hover:bg-green-800 transition ${activeTab === 'jobs' ? 'bg-green-800 border-l-4 border-yellow-400' : ''}`}
                            >
                                <i className="fas fa-briefcase w-6"></i> Careers
                            </button>
                            <button 
                                onClick={() => { setActiveTab('companies'); setViewMode('list'); }}
                                className={`w-full text-left py-3 px-6 hover:bg-green-800 transition ${activeTab === 'companies' ? 'bg-green-800 border-l-4 border-yellow-400' : ''}`}
                            >
                                <i className="fas fa-building w-6"></i> Portfolio
                            </button>
                        </nav>
                        <div className="p-4 border-t border-green-800">
                            <div className="mb-2 text-sm text-green-300 truncate">{user.email}</div>
                            <button onClick={handleLogout} className="w-full bg-red-600 hover:bg-red-700 py-2 rounded text-sm">
                                Logout
                            </button>
                        </div>
                    </aside>

                    {/* Main Content */}
                    <main className="flex-1 p-8 overflow-y-auto">
                        {renderContent()}
                    </main>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>